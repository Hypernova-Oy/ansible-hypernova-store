---
- name: Get the package facts
  package_facts:
    manager: auto

- name: Install makepasswd if it is absent
  apt:
    name: makepasswd
    state: present
    tags:
      - packages
    when: '"makepasswd" not in ansible_facts.packages'

- name: Generate four random char to secure new user name
  shell: makepasswd --chars=4
  register: user_fourword

- name: Check if user exists
  getent:
    database: passwd
    key: "{{ new_user_name }}{{user_fourword.stdout }}"
    register: user_exist
    ignore_errors: yes # continue with the playbook

- name: Generate password for new user
  shell: makepasswd --chars=20
  register: user_password
  when: user_exist.rc == 0

- name: Generate encrypted password
  shell: mkpasswd --method=SHA-512 "{{ user_password.stdout }}"
  register: encrypted_user_password
  when: user_exist.rc == 0

- name: Create user account
  user: name="{{ new_user_name }}{{user_fourword.stdout }}"
    password="{{ encrypted_user_password.stdout }}"
    state=present
    append=yes
    shell="/bin/bash"
    update_password=always
  when: new_user_name is defined and new_user_name in uids and user_exist.rc == 0
  register: user_created
  
- name: Determine available groups
  getent:
    database: group
    key: ssh
    register: group_exist

- name: Ensure group "ssh" exists
  group:
    name: ssh
    state: present
  when: group_exist.rc == 0

- name: Add additional groups to user
  user: name="{{ new_user_name }}{{user_fourword.stdout }}" groups="{{item}}" append=yes
  when: item in ansible_facts.getent_group
  with_items: 
  - sudo
  - www-data
  - ssh

- name: User created
  debug: msg='Password for "{{ new_user_name }}{{user_fourword.stdout }}" is "{{ user_password.stdout }}"'
  when: user_created.changed